<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rekap Pengeluaran Bulanan</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- LOGIN -->
  <div id="login-section" class="flex items-center justify-center min-h-screen">
    <div class="bg-white p-6 rounded shadow-md w-80">
      <h2 class="text-lg font-semibold mb-4 text-center">Login Pengeluaran</h2>
      <input id="email" type="email" placeholder="Email" class="border w-full p-2 mb-2 rounded">
      <input id="password" type="password" placeholder="Password" class="border w-full p-2 mb-4 rounded">
      <button onclick="login()" class="bg-orange-600 text-white w-full py-2 rounded hover:bg-orange-700">Login</button>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="hidden p-4 max-w-3xl mx-auto">
    <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
      <h2 class="text-xl font-semibold text-orange-700">Dashboard Pengeluaran</h2>
      <button onclick="logout()" class="bg-red-500 text-white px-3 py-1 rounded">Logout</button>
    </div>

    <!-- Ringkasan -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
      <div class="bg-white p-3 rounded shadow text-center">
        <p class="text-gray-600 text-sm">Total Pengeluaran</p>
        <p id="totalPengeluaran" class="text-xl font-semibold text-red-600">Rp0</p>
      </div>
      <div class="bg-white p-3 rounded shadow text-center">
        <p class="text-gray-600 text-sm">Sisa Limit</p>
        <p id="sisaLimit" class="text-xl font-semibold text-green-600">-</p>
      </div>
      <div class="bg-white p-3 rounded shadow text-center">
        <p class="text-gray-600 text-sm">Utilisasi</p>
        <p id="utilisasi" class="text-xl font-semibold text-blue-600">0%</p>
      </div>
    </div>

    <!-- Atur Limit -->
    <div class="bg-white p-4 rounded shadow mb-4">
      <h3 class="font-semibold mb-2">Atur Limit Bulanan</h3>
      <div class="flex flex-col sm:flex-row gap-2">
        <input id="bulan" type="month" class="border p-2 rounded flex-1">
        <input id="limit" type="number" placeholder="Limit (Rp)" class="border p-2 rounded flex-1">
        <button onclick="simpanLimit()" class="bg-orange-600 text-white px-3 py-2 rounded">Simpan</button>
      </div>
    </div>

    <!-- Tambah Pengeluaran -->
    <div class="bg-white p-4 rounded shadow mb-4">
      <h3 class="font-semibold mb-2">Tambah Pengeluaran</h3>
      <div class="grid grid-cols-1 sm:grid-cols-5 gap-2">
        <input id="tanggal" type="date" class="border p-2 rounded sm:col-span-1">
        <select id="kategori" class="border p-2 rounded sm:col-span-1">
          <option value="food & beverages">Food & Beverages</option>
          <option value="entertainment">Entertainment</option>
          <option value="groceries">Groceries</option>
        </select>
        <input id="catatan" type="text" placeholder="Catatan" class="border p-2 rounded sm:col-span-2">
        <input id="nominal" type="number" placeholder="Nominal (Rp)" class="border p-2 rounded sm:col-span-1">
      </div>
      <button onclick="tambahPengeluaran()" class="mt-3 bg-orange-600 text-white px-4 py-2 rounded w-full sm:w-auto">Tambah</button>
    </div>

    <!-- Riwayat Pengeluaran -->
    <div class="bg-white p-4 rounded shadow overflow-x-auto">
      <div class="flex justify-between items-center mb-3 flex-wrap gap-2">
        <h3 class="font-semibold">Riwayat Pengeluaran</h3>
        <select id="sortBy" onchange="loadPengeluaran()" class="border rounded px-2 py-1 text-sm">
          <option value="date-desc" selected>Tanggal (Terbaru)</option>
          <option value="date-asc">Tanggal (Terlama)</option>
          <option value="amount-desc">Nominal (Terbesar)</option>
          <option value="amount-asc">Nominal (Terkecil)</option>
          <option value="category-asc">Kategori (A-Z)</option>
        </select>
      </div>
      <table class="w-full text-sm border-collapse">
        <thead>
          <tr class="bg-orange-100">
            <th class="border p-2">Tanggal</th>
            <th class="border p-2">Kategori</th>
            <th class="border p-2">Catatan</th>
            <th class="border p-2">Nominal</th>
            <th class="border p-2">Aksi</th>
          </tr>
        </thead>
        <tbody id="tabelPengeluaran"></tbody>
      </table>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDlTuRouYleRsIqY1e0dVs0DdUn9vpGsaw",
      authDomain: "pengeluaran-83a36.firebaseapp.com",
      projectId: "pengeluaran-83a36",
      storageBucket: "pengeluaran-83a36.firebasestorage.app",
      messagingSenderId: "1092761187117",
      appId: "1:1092761187117:web:0acba9a85b81f1b0c9d9a4",
      measurementId: "G-LKF5YFEC8P"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Set default date
    document.getElementById("tanggal").value = new Date().toISOString().split("T")[0];

    // LOGIN
    window.login = async function() {
      const email = email.value;
      const password = password.value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
        login-section.style.display = "none";
        dashboard.style.display = "block";
        loadRingkasan();
        loadPengeluaran();
      } catch (err) {
        alert("Login gagal: " + err.message);
      }
    }

    window.logout = async function() {
      await signOut(auth);
      login-section.style.display = "flex";
      dashboard.style.display = "none";
    }

    // LIMIT
    window.simpanLimit = async function() {
      const bulan = bulan.value;
      const limitVal = parseInt(limit.value);
      if(!bulan || !limitVal) return alert("Isi bulan dan limit!");
      const uid = auth.currentUser.uid;
      await setDoc(doc(db, "limits", uid + "_" + bulan), { uid, bulan, limit: limitVal });
      alert("Limit bulanan disimpan!");
      loadRingkasan();
    }

    async function getLimit(bulan) {
      const uid = auth.currentUser.uid;
      const q = query(collection(db, "limits"), where("uid", "==", uid), where("bulan", "==", bulan));
      const snap = await getDocs(q);
      if (!snap.empty) return snap.docs[0].data().limit;
      return null;
    }

    // TAMBAH
    window.tambahPengeluaran = async function() {
      const tanggalVal = tanggal.value;
      const kategoriVal = kategori.value;
      const catatanVal = catatan.value;
      const nominalVal = parseInt(nominal.value);
      if(!tanggalVal || !nominalVal) return alert("Tanggal & nominal wajib diisi");
      await addDoc(collection(db, "pengeluaran"), {
        uid: auth.currentUser.uid,
        tanggal: tanggalVal,
        kategori: kategoriVal,
        catatan: catatanVal,
        nominal: nominalVal,
        createdAt: new Date()
      });
      catatan.value = ""; nominal.value = "";
      loadRingkasan(); loadPengeluaran();
    }

    // RINGKASAN
    async function loadRingkasan() {
      const bulanVal = bulan.value || new Date().toISOString().slice(0,7);
      bulan.value = bulanVal;
      const q = query(collection(db, "pengeluaran"), where("uid", "==", auth.currentUser.uid));
      const snap = await getDocs(q);
      let total = 0;
      snap.forEach(d => {
        const p = d.data();
        if (p.tanggal.startsWith(bulanVal)) total += p.nominal;
      });
      const limitVal = await getLimit(bulanVal) || 0;
      const sisa = limitVal ? (limitVal - total) : "-";
      const util = limitVal ? ((total/limitVal)*100).toFixed(1) : "0";
      totalPengeluaran.innerText = "Rp" + total.toLocaleString();
      sisaLimit.innerText = limitVal ? "Rp" + sisa.toLocaleString() : "-";
      utilisasi.innerText = util + "%";
    }

    // RIWAYAT
    async function loadPengeluaran() {
      const bulanVal = bulan.value || new Date().toISOString().slice(0,7);
      const sortOption = document.getElementById("sortBy")?.value || "date-desc";
      const q = query(collection(db, "pengeluaran"), where("uid", "==", auth.currentUser.uid));
      const snap = await getDocs(q);

      let data = [];
      snap.forEach(d => {
        const p = d.data();
        p.id = d.id;
        if (p.tanggal.startsWith(bulanVal)) data.push(p);
      });

      data.sort((a,b)=>{
        switch(sortOption){
          case "date-asc": return a.tanggal.localeCompare(b.tanggal);
          case "date-desc": return b.tanggal.localeCompare(a.tanggal);
          case "amount-asc": return a.nominal - b.nominal;
          case "amount-desc": return b.nominal - a.nominal;
          case "category-asc": return (a.kategori||"").localeCompare(b.kategori||"");
          default: return 0;
        }
      });

      let rows = "";
      data.forEach(p=>{
        rows += `
          <tr>
            <td class="border p-2">${p.tanggal}</td>
            <td class="border p-2">${p.kategori}</td>
            <td class="border p-2">${p.catatan||"-"}</td>
            <td class="border p-2">Rp${p.nominal.toLocaleString()}</td>
            <td class="border p-2 text-red-500 cursor-pointer" onclick="hapusPengeluaran('${p.id}')">Hapus</td>
          </tr>`;
      });

      tabelPengeluaran.innerHTML = rows || `<tr><td colspan="5" class="text-center text-gray-500 p-4">Belum ada data</td></tr>`;
    }

    // HAPUS
    window.hapusPengeluaran = async function(id) {
      if(confirm("Yakin ingin menghapus pengeluaran ini?")) {
        await deleteDoc(doc(db, "pengeluaran", id));
        loadRingkasan();
        loadPengeluaran();
      }
    }
  </script>
</body>
</html>
