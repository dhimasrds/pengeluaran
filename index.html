<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rekap Pengeluaran Bulanan (Secure)</title>
  <!-- 
  ==========================
  SETUP SUPABASE (once)
  ==========================
  
  ADMIN: Nonaktifkan reset password via email
  -------------------------------------------
  • Auth → Providers → Email:
    - Biarkan **Email Provider: ON** (agar login email+password tetap bisa).
    - Matikan **Email confirmations** (tidak perlu konfirmasi email).
  • Auth → Configuration → SMTP:
    - Hapus/disable konfigurasi SMTP (atau gunakan dummy) agar Supabase tidak dapat mengirim email recovery.
  • Di aplikasi ini tidak ada tombol "Lupa Password" atau magic link.
  • Perubahan password hanya bisa dilakukan setelah login melalui menu **Keamanan → Ubah Password**.

  1) Buat project di https://supabase.com (free tier).
  2) Catat SUPABASE_URL & ANON_PUBLIC_KEY dari Settings → API.
  3) Di SQL Editor, jalankan skrip berikut untuk membuat tabel & kebijakan RLS yang AMAN.

  -------------------- SQL START --------------------
  -- 1) Tabel daftar user yang diizinkan (hanya 2 user)
  create table if not exists public.allowed_users (
    user_id uuid primary key
  );

  -- 2) Tabel pengeluaran
  create table if not exists public.expenses (
    id uuid primary key default gen_random_uuid(),
    user_id uuid not null,
    date date not null,
    category text not null,
    note text,
    amount bigint not null check (amount >= 0),
    inserted_at timestamptz default now()
  );

  -- 3) Index untuk query per bulan
  create index if not exists idx_expenses_user_date on public.expenses(user_id, date);

  -- 4) Aktifkan RLS
  alter table public.expenses enable row level security;

  -- 5) Policy: hanya pemilik data + terdaftar di allowed_users yang bisa CRUD
  drop policy if exists "crud_own_when_allowed" on public.expenses;
  create policy "crud_own_when_allowed" on public.expenses
    for all using (
      auth.uid() = user_id
      and exists (select 1 from public.allowed_users au where au.user_id = auth.uid())
    )
    with check (
      auth.uid() = user_id
      and exists (select 1 from public.allowed_users au where au.user_id = auth.uid())
    );

  -- 6) (Opsional) Matikan sign-up publik / pakai invite-only di Auth Settings.

  -- 7) Daftarkan dua email berikut ke allowed_users (jalankan setelah keduanya muncul di Auth → Users)
  insert into public.allowed_users(user_id)
  select id from auth.users
  where email in ('dhimassaputra72@gmail.com', 'nikensesal@gmail.com')
  on conflict (user_id) do nothing;
  -------------------- SQL END ----------------------
  -->

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --radius: 16px; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .card { border-radius: var(--radius); box-shadow: 0 6px 24px rgba(0,0,0,.08); border: 1px solid rgba(0,0,0,.06); }
    .btn { border-radius: calc(var(--radius) - 8px); padding: .65rem 1rem; font-weight: 600; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-secondary { background: #f3f4f6; }
    .input { border: 1px solid rgba(0,0,0,.12); border-radius: 12px; padding: .6rem .8rem; width: 100%; }
    .input:focus { outline: 2px solid #2563eb33; border-color: #2563eb; }
    .chip { border-radius: 999px; padding: .2rem .6rem; font-size: .75rem; }
    .progress-wrap { height: 12px; border-radius: 999px; background: #e5e7eb; overflow: hidden; }
    .progress { height: 100%; width: 0%; transition: width .3s ease; }
    .table-wrap { overflow-x: auto; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#f3f4f6; padding:.1rem .4rem; border-radius:.25rem; border:1px solid #e5e7eb }
    .disabled { opacity: .6; pointer-events: none; }
  </style>
</head>
<body class="bg-white text-slate-900 min-h-screen">
  <div class="max-w-4xl mx-auto p-4 sm:p-6">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl sm:text-3xl font-bold">Rekap Pengeluaran Bulanan (Secure)</h1>
      <div class="flex items-center gap-3">
        <span id="userEmail" class="text-sm text-slate-600"></span>
        <button id="logoutBtn" class="btn btn-secondary hidden">Keluar</button>
      </div>
    </header>

    <!-- Keamanan: Ubah Password -->
    <section id="security" class="card p-5 sm:p-6 mb-6 hidden">
      <h2 class="text-xl font-semibold mb-1">Keamanan</h2>
      <p class="text-sm text-slate-500 mb-4">Ubah password akun Anda. Minimal 8 karakter.</p>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <div>
          <label class="text-sm text-slate-600">Password Baru</label>
          <input id="newPass" type="password" class="input mt-1" placeholder="••••••••" />
        </div>
        <div>
          <label class="text-sm text-slate-600">Konfirmasi Password</label>
          <input id="confirmPass" type="password" class="input mt-1" placeholder="••••••••" />
        </div>
        <div class="flex items-end">
          <button id="changePassBtn" class="btn btn-primary w-full">Ubah Password</button>
        </div>
      </div>
      <div id="changePassMsg" class="text-sm mt-3"></div>
    </section>

    <!-- Auth Card -->
    <section id="authCard" class="card p-5 sm:p-6">
      <h2 class="text-xl font-semibold mb-1">Masuk</h2>
      <p class="text-sm text-slate-500 mb-4">Login aman dengan Supabase Auth. Admin membatasi akses hanya untuk 2 email melalui <code>allowed_users</code>.<br><strong>Default password sementara:</strong> <code>Sementara#2025</code> (set dari Dashboard Supabase untuk kedua email).</p>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div>
          <label class="text-sm text-slate-600">Email</label>
          <input id="email" type="email" class="input mt-1" placeholder="nama@contoh.com" />
        </div>
        <div>
          <label class="text-sm text-slate-600">Password</label>
          <input id="password" type="password" class="input mt-1" placeholder="••••••••" />
        </div>
      </div>
      <div class="mt-4 flex items-center gap-3 flex-wrap">
        <button id="loginBtn" class="btn btn-primary">Masuk</button>
        <!-- Signup & Magic Link dinonaktifkan untuk publik -->
        <span class="text-xs text-slate-500">Sign-up publik dimatikan. Hanya email yang diizinkan dapat login.</span>
        <span id="authMsg" class="text-sm"></span>
      </div>

      <details class="mt-4">
        <summary class="cursor-pointer text-sm text-slate-600">Petunjuk admin (batasi 2 user)</summary>
        <div class="text-sm text-slate-600 mt-2 space-y-2">
          <p>1) Tambahkan 2 user melalui <em>Auth → Users</em> (atau undang).<br>2) Salin <em>UUID</em> keduanya dari <em>Auth → Users</em>.<br>3) Masukkan ke tabel <code>allowed_users</code> dengan SQL: <code>insert into public.allowed_users(user_id) values ('uuid1'), ('uuid2');</code><br>4) Selain dua UUID ini, tidak bisa baca/tulis data.</p>
        </div>
      </details>
    </section>

    <!-- App Card -->
    <section id="app" class="card p-5 sm:p-6 hidden">
      <div class="flex flex-col sm:flex-row sm:items-end gap-4">
        <div class="grow grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-slate-600">Bulan</label>
            <input id="monthPicker" type="month" class="input mt-1" />
          </div>
          <div>
            <label class="text-sm text-slate-600">Limit Bulanan (Rp)</label>
            <input id="monthlyLimit" type="number" class="input mt-1" placeholder="mis. 5000000" />
          </div>
        </div>
        <div class="flex gap-3">
          <button id="saveSettings" class="btn btn-secondary">Simpan</button>
          <button id="exportBtn" class="btn btn-secondary">Ekspor</button>
          <label class="btn btn-secondary cursor-pointer">Impor
            <input id="importInput" type="file" accept="application/json" class="hidden" />
          </label>
        </div>
      </div>

      <!-- Summary -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-5">
        <div class="p-4 bg-slate-50 rounded-xl">
          <div class="text-sm text-slate-500">Total Pengeluaran</div>
          <div class="text-2xl font-bold mt-1" id="sumSpent">Rp0</div>
        </div>
        <div class="p-4 bg-slate-50 rounded-xl">
          <div class="text-sm text-slate-500">Sisa dari Limit</div>
          <div class="text-2xl font-bold mt-1" id="sumRemain">Rp0</div>
        </div>
        <div class="p-4 bg-slate-50 rounded-xl">
          <div class="text-sm text-slate-500">Utilisasi</div>
          <div class="text-2xl font-bold mt-1" id="sumUtil">0%</div>
        </div>
      </div>

      <div class="mt-3">
        <div class="progress-wrap">
          <div id="progressBar" class="progress bg-blue-600"></div>
        </div>
        <div id="limitWarning" class="mt-1 text-sm"></div>
      </div>

      <!-- Add Expense -->
      <div class="mt-6 p-4 bg-white border rounded-xl">
        <h3 class="font-semibold mb-3">Tambah Pengeluaran</h3>
        <div class="grid grid-cols-2 sm:grid-cols-6 gap-3">
          <div class="col-span-2 sm:col-span-1">
            <label class="text-sm text-slate-600">Tanggal</label>
            <input id="expDate" type="date" class="input mt-1" />
          </div>
          <div class="col-span-2 sm:col-span-1">
            <label class="text-sm text-slate-600">Kategori</label>
            <select id="expCat" class="input mt-1">
              <option>Makanan</option>
              <option>Transportasi</option>
              <option>Tagihan</option>
              <option>Hiburan</option>
              <option>Belanja</option>
              <option>Kesehatan</option>
              <option>Lainnya</option>
            </select>
          </div>
          <div class="col-span-2 sm:col-span-2">
            <label class="text-sm text-slate-600">Catatan</label>
            <input id="expNote" class="input mt-1" placeholder="mis. makan siang" />
          </div>
          <div class="col-span-1 sm:col-span-1">
            <label class="text-sm text-slate-600">Jumlah (Rp)</label>
            <input id="expAmt" type="number" class="input mt-1" placeholder="0" />
          </div>
          <div class="col-span-1 sm:col-span-1 flex items-end">
            <button id="addBtn" class="btn btn-primary w-full">Tambah</button>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-3">
        <input id="searchInput" class="input" placeholder="Cari catatan / kategori..." />
        <select id="filterCat" class="input">
          <option value="">Semua kategori</option>
          <option>Makanan</option>
          <option>Transportasi</option>
          <option>Tagihan</option>
          <option>Hiburan</option>
          <option>Belanja</option>
          <option>Kesehatan</option>
          <option>Lainnya</option>
        </select>
        <select id="sortBy" class="input">
          <option value="date_desc">Terbaru</option>
          <option value="date_asc">Terlama</option>
          <option value="amt_desc">Nominal terbesar</option>
          <option value="amt_asc">Nominal terkecil</option>
        </select>
      </div>

      <!-- Table -->
      <div class="table-wrap mt-4">
        <table class="min-w-full">
          <thead>
            <tr class="text-left text-slate-500 text-sm">
              <th class="py-2 pr-3">Tanggal</th>
              <th class="py-2 pr-3">Kategori</th>
              <th class="py-2 pr-3">Catatan</th>
              <th class="py-2 pr-3">Jumlah (Rp)</th>
              <th class="py-2">Aksi</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <p class="text-xs text-slate-400 mt-6">Data tersimpan aman di Postgres (Supabase) dengan Row Level Security. Ekspor/Impor tersedia.</p>
    </section>

    <!-- Diagnostics (Test Cases) -->
    <section id="diagnostics" class="card p-5 sm:p-6 mt-6 hidden">
      <h2 class="text-xl font-semibold mb-1">Diagnostics</h2>
      <p class="text-sm text-slate-500 mb-4">Panel pengujian internal untuk memastikan fungsi dasar bekerja. Tekan tombol untuk menjalankan.</p>
      <div class="flex gap-3 flex-wrap">
        <button id="runTests" class="btn btn-secondary">Run Tests</button>
        <span class="text-xs text-slate-500">Tampilkan panel ini dengan query <span class="kbd">?test=1</span></span>
      </div>
      <pre id="testOutput" class="mt-4 text-xs bg-slate-50 p-3 rounded-lg overflow-auto max-h-64"></pre>
    </section>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    // ======= CONFIGURASI: ISI DENGAN PUNYAMU =======
    const SUPABASE_URL = 'https://hcjwtywhqqpoadunmejm.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhjand0eXdocXFwb2FkdW5tZWptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzMTY5MDMsImV4cCI6MjA3NDg5MjkwM30.rFbM1M5PwkQmC5ZbtwesKrjLSjHmW_NfikYcZRyvRHg';

    // ======= ALLOWED LOGIN EMAILS (hard-allowlist) =======
    const ALLOWED_EMAILS = new Set(['dhimassaputra72@gmail.com', 'nikensesal@gmail.com']);

    // Password default sementara
    

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---------- Helpers ----------
    const qs = (sel) => document.querySelector(sel);
    const fmtIDR = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(n || 0);
    const todayStr = () => new Date().toISOString().slice(0,10);
    function yearMonthStr(d = new Date()) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      return `${y}-${m}`;
    }
    function monthRangeFromYM(ym){
      try{
        const [yy, mm] = ym.split('-').map(Number);
        const start = new Date(yy, (mm||1)-1, 1);
        const next = new Date(yy, (mm||1), 1);
        const s = start.toISOString().slice(0,10);
        const e = next.toISOString().slice(0,10);
        return [s, e];
      } catch { return [null, null]; }
    }

    // ---------- State ----------
    let state = {
      session: null,
      user: null,
      ym: yearMonthStr(),
      items: [],
      monthlyLimit: 0,
      filters: { q: '', cat: '', sortBy: 'date_desc' },
    };

    // ---------- Auth UI ----------
    const authCard = qs('#authCard');
    const appCard = qs('#app');
    const logoutBtn = qs('#logoutBtn');
    const userEmail = qs('#userEmail');

    function setAuthMsg(msg, isErr=false){
      const el = qs('#authMsg');
      el.textContent = msg || '';
      el.className = 'text-sm ' + (isErr? 'text-rose-600' : 'text-slate-600');
    }

    // Login handler
    qs('#loginBtn').addEventListener('click', async () => {
      const email = qs('#email').value.trim();
      const password = qs('#password').value;
      setAuthMsg('');

      
      // Guard: konfigurasi Supabase harus diisi
      if (SUPABASE_URL.includes('YOUR_PROJECT_ID') || SUPABASE_ANON_KEY.includes('YOUR_ANON_PUBLIC_KEY')){
        setAuthMsg('Konfigurasi Supabase belum diisi. Ganti SUPABASE_URL & SUPABASE_ANON_KEY.', true);
        return; // aman: di dalam event handler
      }

      try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
          let extra = '';
          const details = `
[DEBUG] email=${email} | len(password)=${(password||'').length}`;
          const tip = `
• Pastikan user dibuat lewat Auth → Users dengan password diisi.
• Di Providers → Email: aktifkan Email Provider, dan matikan Email confirmations.
• Di Users, cek kolom “Confirmed at”. Jika kosong & confirmations ON, login akan ditolak.`;
          if ((error.message || '').toLowerCase().includes('invalid login credentials')) {
            extra = `
${tip}${details}`;
          } else {
            extra = `
• Kode error: ${error.name || 'n/a'}
• Deskripsi: ${error.message}${details}`;
          }
          setAuthMsg('Login gagal: ' + error.message + extra, true);
          return; // aman: di dalam event handler
        }
        await afterAuth();
      } catch (e){
        setAuthMsg('Gagal login: ' + e.message, true);
      }
    });

    // Tombol signup & magic link sengaja TIDAK ada di UI (dinonaktifkan)

    // Logout
    logoutBtn.addEventListener('click', async () => {
      await supabase.auth.signOut();
      state = { ...state, session: null, user: null, items: [] };
      userEmail.textContent = '';
      appCard.classList.add('hidden');
      authCard.classList.remove('hidden');
      logoutBtn.classList.add('hidden');
      qs('#security')?.classList.add('hidden');
    });

    // Session listener
    supabase.auth.onAuthStateChange(async (_event, session) => {
      state.session = session;
      state.user = session?.user || null;

      if (state.user && !ALLOWED_EMAILS.has(state.user.email)){
        await supabase.auth.signOut();
        state.user = null;
        setAuthMsg('Akun ini tidak diizinkan mengakses aplikasi. Hubungi admin.', true);
        return; // aman: di dalam callback
      }

      if (state.user) {
        await initApp();
      }
    });

    // On load, fetch current session
    {
      const { data: { session } } = await supabase.auth.getSession();
      state.session = session; state.user = session?.user || null;
      if (state.user && !ALLOWED_EMAILS.has(state.user.email)){
        await supabase.auth.signOut();
        state.user = null;
        setAuthMsg('Akun ini tidak diizinkan mengakses aplikasi. Hubungi admin.', true);
      } else if (state.user) {
        await initApp();
      }
    }

    async function afterAuth(){
      const { data: { session } } = await supabase.auth.getSession();
      state.session = session; state.user = session?.user || null;
      if (state.user && !ALLOWED_EMAILS.has(state.user.email)){
        await supabase.auth.signOut();
        state.user = null;
        setAuthMsg('Akun ini tidak diizinkan mengakses aplikasi. Hubungi admin.', true);
        return; // aman: di dalam fungsi
      }
      if (state.user) {
        await initApp();
      }
    }

    async function initApp(){
      // tampilkan section keamanan setelah login
      qs('#security')?.classList.remove('hidden');
      authCard.classList.add('hidden');
      appCard.classList.remove('hidden');
      logoutBtn.classList.remove('hidden');
      userEmail.textContent = state.user?.email || '';

      // init controls
      qs('#monthPicker').value = state.ym;
      qs('#expDate').value = todayStr();

      // load settings (per user) via localStorage (opsional)
      const settingsKey = `settings:${state.user.id}`;
      const raw = localStorage.getItem(settingsKey);
      const s = raw ? JSON.parse(raw) : { monthlyLimit: 0 };
      state.monthlyLimit = Number(s.monthlyLimit||0);
      qs('#monthlyLimit').value = state.monthlyLimit || '';

      // fetch data bulan ini
      await loadMonth(state.ym);
      render();
    }

    // ---------- Data ops ----------
    async function loadMonth(ym){
      const [startDate, nextMonthStart] = monthRangeFromYM(ym);
      const { data, error } = await supabase
        .from('expenses')
        .select('*')
        .gte('date', startDate)
        .lt('date', nextMonthStart)
        .order('date', { ascending: false });
      if (error) {
        console.error(error);
        alert('Gagal memuat data. Pastikan user Anda termasuk allowed_users.');
        state.items = [];
      } else {
        state.items = data || [];
      }
    }

    async function addExpense({ date, category, note, amount }){
      const payload = { user_id: state.user.id, date, category, note, amount: Number(amount||0) };
      const { data, error } = await supabase.from('expenses').insert(payload).select('*').single();
      if (error) throw error;
      return data;
    }

    async function updateExpense(id, { date, category, note, amount }){
      const { data, error } = await supabase
        .from('expenses')
        .update({ date, category, note, amount: Number(amount||0) })
        .eq('id', id)
        .select('*')
        .single();
      if (error) throw error;
      return data;
    }

    async function deleteExpense(id){
      const { error } = await supabase.from('expenses').delete().eq('id', id);
      if (error) throw error;
    }

    // ---------- Events ----------
    qs('#monthPicker').addEventListener('change', async (e) => {
      state.ym = e.target.value || yearMonthStr();
      await loadMonth(state.ym);
      render();
    });

    qs('#saveSettings').addEventListener('click', () => {
      const lim = Number(qs('#monthlyLimit').value || 0);
      state.monthlyLimit = lim;
      localStorage.setItem(`settings:${state.user.id}`, JSON.stringify({ monthlyLimit: lim }));
      renderSummary();
    });

    qs('#addBtn').addEventListener('click', async () => {
      try {
        const date = qs('#expDate').value || todayStr();
        const category = qs('#expCat').value.trim();
        const note = qs('#expNote').value.trim();
        const amount = Number(qs('#expAmt').value || 0);
        if (!amount || amount < 0) { alert('Nominal tidak valid'); return; }
        const created = await addExpense({ date, category, note, amount });
        state.items.unshift(created);
        qs('#expNote').value=''; qs('#expAmt').value='';
        render();
      } catch(err){
        alert('Gagal menambah: ' + err.message);
      }
    });

    qs('#searchInput').addEventListener('input', (e) => { state.filters.q = e.target.value.toLowerCase(); renderTable(); });
    qs('#filterCat').addEventListener('change', (e) => { state.filters.cat = e.target.value; renderTable(); });
    qs('#sortBy').addEventListener('change', (e) => { state.filters.sortBy = e.target.value; renderTable(); });

    // Export / Import (via JSON lokal, bukan dari DB)
    qs('#exportBtn').addEventListener('click', () => {
      const payload = {
        user: state.user.id,
        exportedAt: new Date().toISOString(),
        data: {
          settings: JSON.parse(localStorage.getItem(`settings:${state.user.id}`) || '{"monthlyLimit":0}'),
          months: { [state.ym]: state.items }
        }
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `expense_${state.user.id}_${state.ym}.json`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    qs('#importInput').addEventListener('change', async (e) => {
      const file = e.target.files[0]; if (!file) return;
      try {
        const text = await file.text();
        const obj = JSON.parse(text);
        if (!obj || !obj.data || !obj.data.months) throw new Error('Format tidak dikenali');
        const arr = obj.data.months[state.ym] || [];
        // Impor ke DB: insert satu per satu (atau gunakan upsert jika ingin id sama)
        for (const r of arr){
          await addExpense({ date: r.date, category: r.category||r.cat, note: r.note, amount: r.amount||r.amt });
        }
        await loadMonth(state.ym);
        render();
        alert('Impor berhasil');
      } catch (err) {
        alert('Gagal impor: ' + err.message);
      } finally {
        e.target.value = '';
      }
    });

    // ---------- Render ----------
    function render(){
      renderSummary();
      renderTable();
    }

    function renderSummary(){
      const spent = state.items.reduce((a,b)=>a + (Number(b.amount)||0), 0);
      const limit = Number(state.monthlyLimit||0);
      const remain = Math.max(0, limit - spent);
      const util = limit>0 ? Math.min(100, Math.round(spent/limit*100)) : 0;
      qs('#sumSpent').textContent = fmtIDR(spent);
      qs('#sumRemain').textContent = limit? fmtIDR(remain) : '—';
      qs('#sumUtil').textContent = `${util}%`;

      const bar = qs('#progressBar');
      bar.style.width = `${limit? Math.min(100, spent/limit*100) : 0}%`;
      bar.className = 'progress';
      if (!limit) bar.classList.add('bg-gray-400');
      else if (spent <= limit*0.75) bar.classList.add('bg-green-600');
      else if (spent <= limit) bar.classList.add('bg-yellow-500');
      else bar.classList.add('bg-rose-600');

      const warn = qs('#limitWarning');
      if (!limit) { warn.textContent = 'Tips: atur limit bulanan agar pengeluaran terkontrol.'; warn.className = 'mt-1 text-sm text-slate-500'; }
      else if (spent > limit) { warn.textContent = '⚠️ Melebihi limit! Kurangi pengeluaran bulan ini.'; warn.className = 'mt-1 text-sm text-rose-600 font-semibold'; }
      else if (spent > limit*0.9) { warn.textContent = '⚠️ Hampir mencapai limit. Hati-hati ya.'; warn.className = 'mt-1 text-sm text-amber-600 font-semibold'; }
      else { warn.textContent = ''; }
    }

    function renderTable(){
      const tbody = qs('#rows');
      const q = state.filters.q;
      const cat = state.filters.cat;
      const sortBy = state.filters.sortBy;

      let rows = state.items.slice();
      if (q) rows = rows.filter(r => (r.note||'').toLowerCase().includes(q) || (r.category||'').toLowerCase().includes(q));
      if (cat) rows = rows.filter(r => r.category === cat);
      rows.sort((a,b)=>{
        if (sortBy==='date_desc') return (b.date||'').localeCompare(a.date||'');
        if (sortBy==='date_asc') return (a.date||'').localeCompare(b.date||'');
        if (sortBy==='amt_desc') return (b.amount||0) - (a.amount||0);
        if (sortBy==='amt_asc') return (a.amount||0) - (b.amount||0);
        return 0;
      });

      tbody.innerHTML = '';
      if (!rows.length){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="5" class="py-6 text-center text-slate-500">Belum ada data untuk bulan ini.</td>`;
        tbody.appendChild(tr);
        renderSummary();
        return;
      }

      for (const r of rows){
        const tr = document.createElement('tr');
        tr.className = 'border-b border-slate-100';
        tr.innerHTML = `
          <td class="py-2 pr-3 whitespace-nowrap">${r.date||''}</td>
          <td class="py-2 pr-3"><span class="chip bg-slate-100">${r.category||''}</span></td>
          <td class="py-2 pr-3 max-w-[280px] truncate" title="${(r.note||'').replace(/"/g,'&quot;')}">${r.note||''}</td>
          <td class="py-2 pr-3 font-semibold">${fmtIDR(r.amount||0)}</td>
          <td class="py-2 flex gap-2">
            <button class="btn btn-secondary" data-act="edit" data-id="${r.id}">Ubah</button>
            <button class="btn btn-secondary" data-act="del" data-id="${r.id}">Hapus</button>
          </td>`;
        tbody.appendChild(tr);
      }

      // delegate actions
      tbody.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          const act = btn.getAttribute('data-act');
          if (act==='del') {
            if (confirm('Hapus pengeluaran ini?')){
              try { await deleteExpense(id); await loadMonth(state.ym); render(); } catch(err){ alert('Gagal hapus: '+err.message); }
            }
          } else if (act==='edit') {
            const item = state.items.find(x=>x.id===id); if (!item) return;
            const nd = prompt('Tanggal (YYYY-MM-DD):', item.date||''); if (!nd) return;
            const nc = prompt('Kategori:', item.category||''); if (nc===null) return;
            const nn = prompt('Catatan:', item.note||''); if (nn===null) return;
            const na = Number(prompt('Jumlah (Rp):', item.amount)); if (!na && na!==0) return;
            try { await updateExpense(id, { date: nd, category: nc, note: nn, amount: na }); await loadMonth(state.ym); render(); } catch(err){ alert('Gagal ubah: '+err.message); }
          }
        });
      });

      renderSummary();
    }

    // Change password handler
    const changePassBtn = document.querySelector('#changePassBtn');
    if (changePassBtn){
      changePassBtn.addEventListener('click', async () => {
        const np = document.querySelector('#newPass').value;
        const cp = document.querySelector('#confirmPass').value;
        const msgEl = document.querySelector('#changePassMsg');
        msgEl.textContent = '';
        msgEl.className = 'text-sm';
        if (!np || np.length < 8) { msgEl.textContent = 'Password minimal 8 karakter.'; msgEl.classList.add('text-rose-600'); return; }
        if (np !== cp) { msgEl.textContent = 'Konfirmasi password tidak cocok.'; msgEl.classList.add('text-rose-600'); return; }
        try {
          const { error } = await supabase.auth.updateUser({ password: np });
          if (error) throw error;
          document.querySelector('#newPass').value = '';
          document.querySelector('#confirmPass').value = '';
          msgEl.textContent = 'Password berhasil diubah.';
          msgEl.classList.add('text-green-600');
        } catch(e){
          msgEl.textContent = 'Gagal mengubah password: ' + e.message;
          msgEl.classList.add('text-rose-600');
        }
      });
    }

    // ===== Diagnostics / Test Cases =====
    const params = new URLSearchParams(location.search);
    if (params.get('test') === '1') {
      qs('#diagnostics')?.classList.remove('hidden');
    }

    function assertEqual(name, got, expected) {
      const ok = JSON.stringify(got) === JSON.stringify(expected);
      return `${ok ? '✅' : '❌'} ${name}: ${ok ? 'OK' : `Got ${JSON.stringify(got)}, expected ${JSON.stringify(expected)}`}`;
    }

    async function runTests(){
      const logs = [];
      // Test 1: fmtIDR
      logs.push(assertEqual('fmtIDR(1000)', typeof fmtIDR(1000), 'string'));

      // Test 2: yearMonthStr fixed format
      const ym = yearMonthStr(new Date('2025-10-01T00:00:00Z'));
      logs.push(assertEqual('yearMonthStr(2025-10-01)', ym, '2025-10'));

      // Test 3: Progress calculation
      const tmp = { ...state };
      state.items = [{ amount: 2000 }, { amount: 3000 }];
      state.monthlyLimit = 10000;
      renderSummary();
      logs.push('✅ Render summary executed without runtime errors');
      state.items = tmp.items; state.monthlyLimit = tmp.monthlyLimit; // restore

      // Test 4: Allowlist — purely static check (no network)
      logs.push(assertEqual('Allowlist contains dhimas', ALLOWED_EMAILS.has('dhimassaputra72@gmail.com'), true));
      logs.push(assertEqual('Allowlist blocks random', ALLOWED_EMAILS.has('random@example.com'), false));
      logs.push(assertEqual('Allowlist contains nikensesal', ALLOWED_EMAILS.has('nikensesal@gmail.com'), true));

      // Test 5: Guard for missing config (with real keys, guard should be false)
      const guard = SUPABASE_URL.includes('YOUR_PROJECT_ID') || SUPABASE_ANON_KEY.includes('YOUR_ANON_PUBLIC_KEY');
      logs.push(assertEqual('Config guard false when keys are set', guard, false));

      // Test 6: Error hint composition for invalid credentials
      {
        const err = { message: 'Invalid login credentials' };
        let extra = '';
        if ((err.message || '').toLowerCase().includes('invalid login credentials')) {
          extra = `\n• Pastikan user sudah dibuat di Auth → Users dan password benar.\n• Jika Email confirmations masih ON, set ke OFF atau tandai user sebagai confirmed.\n• Cek kolom “Confirmed at” di Auth → Users — jika kosong, login bisa ditolak.`;
        }
        logs.push(assertEqual('Error hint starts with bullet', extra.startsWith('\n• '), true));
      }

      // Test 7: no force-change banner exists
      logs.push(assertEqual('No force-change banner', !!document.querySelector('#forceChangeBanner'), false));

      // Test 8: Add button enabled
      const addBtn = document.querySelector('#addBtn');
      logs.push(assertEqual('Add button enabled prop', addBtn ? addBtn.disabled : false, false));

      // Output
      qs('#testOutput').textContent = logs.join('\n');
    }

    qs('#runTests')?.addEventListener('click', runTests);
  </script>
</body>
</html>
